# 事务
* 数据库得到一些操作的集合被认为是一个独立单元，构成单一逻辑工作单元的操作集合称作事务。

## 事务概念(ACID)
* 原子性：访问并可能更新各种数据项的一个程序执行单元。要么全部执行成功，要么一个都不执行。
* 一致性：如果一个事务作为原子从一个一致的数据库状态开始独立地运行，则事务结束时数据库也必须是再次一致的。
* 隔离型：保证事务正常执行而不被来自并发执行的数据库语句干扰。
* 持久性：即使数据库崩溃，事务的操作也必须是持久的。

## 事务原子性和持久性
* 事务并非总能执行成功，这种事务成为中止了(aborted)。
* 中止事务必须对数据库的状态不造成影响，一旦中止事务造成的变更被撤销，就是事务已回滚(rolled back)。
* 成功完成执行的事务称为已提交(committed)。
* 一旦事务已提交，就不能通过中止它来撤销其造成的影响。唯一的办法是执行一个补偿事务(compensating transaction)，需要用户书写和执行。
* 抽象事务模型，事务必须处于下列状态之一
  * 活动的(active)：初始状态，事务执行时处于这个状态。
  * 部分提交的(partially committed)：最后一条语句执行后。
  * 失败的(failed): 发现正常的执行不能继续后。
  * 中止的(aborted): 事务回滚且数据库恢复到事务前状态后。
  * 提交的(committed): 成功完成后。

## 事务隔离性
* 多个事务是可以并发执行的
  * 提高吞吐量和资源利用率
  * 减少等待时间
* 两者方法利用多核优势
  * 发现单个事务或查询内的并行性
  * 支持大量并发的事务
* 数据库系统必须保证并发的安全性
  * 如果并发执行控制完全由OS控制，有可能出现使数据库不一致的调度。
  * 需要保证任何调度的效果都与没有并发执行的调度效果一样，调度的结果应该等价于一个串行调度。称为可串行化调度。

## 可串行化
* 冲突可串行化
  * 如果调度S可经过一系列非冲突指令交换成S',那么S与S'是冲突等价的(conflict equivalent)
* 串行化顺序可通过拓扑排序得到多个线性顺序。

## 事务隔离性级别
* 如果事务在独立执行时保证数据库一致性，那么串行性就能确保并发执行时也具有一致性。
* SQL标准规定的隔离性级别
  * 可串行化(serializable)：通常保证可串行化调度。
  * 可重复读(repeatable read)：只允许已提交数据，而且在一个事务两次读取一个数据项期间，其他事务不得更新该数据。但该事务不要求与其他事务可串行化
  * 已提交读(read committed)：只允许读取已提交数据，但不要求可重复读。
  * 未提交读(read uncommitted)：允许读取未提交数据，是SQL允许的最低一致性级别。
  * 以上所有隔离性级别都不允许脏写，如果一个数据以及被一个进行中的事务写入，则不允许对该数据进行写操作。

## 隔离性级别的实现
* 并发控制机制
  * 无论OS在事务间如何分时共享资源，都只产生可接受的调度。
* 锁
  * 一次只执行一个事务，只会产生串行调度
  * 性能底下，可用读写锁提升
* 时间戳
  * 保证在访问冲突的情况下，事务按照时序来访问数据。
* 多版本和快照隔离
  * 通过维护数据项的多个版本，一个事务允许读取一个旧版本的数据项
  * 在快照隔离中，每个事务开始时有一个私有版本的数据库